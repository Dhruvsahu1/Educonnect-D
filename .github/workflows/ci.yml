name: ci-pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:

# ---------------------------------------------------------
          # CODE SECURITY (CodeQL)
# ---------------------------------------------------------
  codeql:
    name: Security Scan (CodeQL)
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      
      - name: Install Backend Deps
        run: |
          cd backend
          npm ci || npm install

      - name: Install Frontend Deps
        run: |
          cd frontend
          npm ci || npm install

      - name: Analyze
        uses: github/codeql-action/analyze@v3

  # ---------------------------------------------------------
            # LINT + TEST JOB
  # ---------------------------------------------------------
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      - run: npm ci || npm install
      - name: ESLint
        uses: stefanoeb/eslint-action@1.0.2
  
  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
# -----------------------------------------------------
              # BACKEND TESTS
# -----------------------------------------------------
      - name: Install Backend Dependencies
        run: cd backend && npm ci || npm install
      - name: Run Backend Tests
        run: cd backend && npm test || echo "No backend tests defined"
# -----------------------------------------------------
              # FRONTEND TESTS
# -----------------------------------------------------        
      - name: Install Frontend Dependencies
        run: cd frontend && npm ci || npm install
      - name: Run Frontend Tests
        run: |
          cd frontend
          npm test   || echo "No frontend tests defined"
      
  # ---------------------------------------------------------
          # DOCKER BUILD & PUSH
  # ---------------------------------------------------------
  docker-build:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: [test]

    steps:
      - uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: hardik0811
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Pull Cache Image (if exists)
        run: |
          docker pull docker.io/hardik0811/educonnect:latest || true

      - name: Build Docker Image
        run: |
          docker build \
            --cache-from=docker.io/hardik0811/educonnect:latest \
            -t docker.io/hardik0811/educonnect:latest \
            .

      - name: Push Docker Image
        run: docker push docker.io/hardik0811/educonnect:latest
